create database "WHERE_GDB:winfunc.fdb";

create table persons (
  id integer generated by default as identity primary key,
  name varchar(15)
);

create table entries (
  id integer generated by default as identity primary key,
  person integer references persons,
  dat date,
  val numeric(10,2)
);

insert into persons (name) values ('Person 1');
insert into persons (name) values ('Person 2');
insert into persons (name) values ('Person 3');
insert into persons (name) values ('Person 4');
insert into persons (name) values ('Person 5');

insert into entries (person, dat, val) select id, date '2010-01-02' + id, id * 2 + 0.3 from persons;
insert into entries (person, dat, val) select id, date '2010-02-01' + id, id * 3 + 0.4 from persons;
insert into entries (person, dat, val) select id, date '2010-03-01' + id, id * 3 + 0.4 from persons;
insert into entries (person, dat, val) values (1, null, null);

select * from entries;

          ID       PERSON         DAT                   VAL 
============ ============ =========== ===================== 
           1            1 2010-01-03                   2.30 
           2            2 2010-01-04                   4.30 
           3            3 2010-01-05                   6.30 
           4            4 2010-01-06                   8.30 
           5            5 2010-01-07                  10.30 
           6            1 2010-02-02                   3.40 
           7            2 2010-02-03                   6.40 
           8            3 2010-02-04                   9.40 
           9            4 2010-02-05                  12.40 
          10            5 2010-02-06                  15.40 
          11            1 2010-03-02                   3.40 
          12            2 2010-03-03                   6.40 
          13            3 2010-03-04                   9.40 
          14            4 2010-03-05                  12.40 
          15            5 2010-03-06                  15.40 
          16            1      <null>                <null> 


create view v1 (x1, x2, x3, x4, x5, x6, x7, x8) as
  select
      count(*) over (partition by p.id), count(e.val) over (partition by p.id),
      min(e.val) over (partition by p.id), max(e.val) over (partition by p.id),
      count(distinct e.val) over (partition by p.id), min(distinct e.val) over (partition by p.id),
      max(distinct e.val) over (partition by p.id),
      p.name
    from entries e
    join persons p
      on p.id = e.person;

create view v2 as
  select *
    from entries;

create view v3 as
  select v2.person, v2.val, p.name
    from v2
    join persons p
      on p.id = v2.person;

---

exit;
